{% extends "base.html" %}

{% block content %}
<div class="grid" style="grid-template-columns: 2fr 1fr; align-items: start;">
  <div class="card">
    <h2 style="margin-top:0;">Tracked items</h2>
    {% if products %}
    <form id="reorder-form" method="post" action="/reorder" style="display:none;">
      <input type="hidden" id="reorder-input" name="order" value="" />
    </form>
    <table>
      <thead>
        <tr>
          <th></th>
          <th>ID</th>
          <th>Name</th>
          <th>Last price</th>
          <th>24h</th>
          <th>Seen</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="products-body">
        {% for p in products %}
        <tr data-pid="{{ p.id }}">
          <td style="white-space:nowrap; width: 28px;">
            <span class="drag-handle" draggable="true" title="Drag to reorder" aria-label="Drag to reorder">⋮⋮</span>
          </td>
          <td>{{ p.id }}</td>
          <td>
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
              <div><a href="/product/{{ p.id }}">{{ p.name }}</a></div>
              <div style="display:flex; align-items:center; gap:8px;">
                <button class="icon-btn edit-btn" type="button" title="Edit name" aria-label="Edit name">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm2.92 2.83H5v-.92l8.06-8.06.92.92-8.06 8.06zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
                  </svg>
                </button>
                <form method="post" action="/delete/{{ p.id }}" onsubmit="return confirm('Delete this product and history?');" style="display:inline; margin:0;">
                  <button class="icon-btn danger" type="submit" title="Remove" aria-label="Remove">
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                      <path d="M6 7h12l-1 14H7L6 7zm3-3h6l1 2H8l1-2zm-4 2h14v2H5V6z"/>
                    </svg>
                  </button>
                </form>
              </div>
            </div>
            <div class="muted">{{ p.source }} &middot; <a href="{{ p.url }}" target="_blank">link</a></div>

            <div class="rename-box" hidden>
              <form method="post" action="/rename/{{ p.id }}" style="margin-top:10px; display:flex; gap:10px; align-items:center;">
                <input name="name" type="text" value="{{ p.name }}" style="max-width:460px;" />
                <button class="btn" type="submit">Save</button>
              </form>
            </div>
          </td>
          <td>{% if p.last_price %}{{ '%.2f' % p.last_price }} {{ p.currency }}{% else %}<span class="muted">n/a</span>{% endif %}</td>
          <td>
            {% if p.change_24h is not none %}
              {% if p.change_24h > 0 %}+{% endif %}{{ '%.2f' % p.change_24h }} {{ p.currency }}
            {% else %}
              <span class="muted">n/a</span>
            {% endif %}
          </td>
          <td class="muted">{{ p.last_seen or '' }}</td>
          <td>{% if p.error %}<span class="tag" style="border-color:#f5f5f5;color:#f5f5f5;">{{ p.error }}</span>{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="muted">Nothing tracked yet.</p>
    {% endif %}
  </div>
  <div class="grid" style="grid-template-columns: 1fr; align-content: start;">
    <div class="card">
      <h3 style="margin-top:0;">Add product</h3>
      <form method="post" action="/add">
        <label for="url">Product URL</label>
        <input id="url" name="url" type="text" placeholder="https://..." required>
        <label for="name" style="margin-top:12px;">Display name (optional)</label>
        <input id="name" name="name" type="text" placeholder="Will fall back to page title">
        <div style="margin-top:14px; display:flex; gap:10px;">
          <button class="btn primary" type="submit">Add and fetch</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h3 style="margin-top:0;">Search (top 5)</h3>
      <form method="post" action="/search" style="display:grid; gap:10px;">
        <div>
          <label for="store">Store</label>
          <select id="store" name="store">
            <option value="xkom" {% if search_store in ['xkom','x-kom','x-kom.pl','xkom.pl','x-kom'] %}selected{% endif %}>x-kom</option>
            <option value="morele" {% if search_store in ['morele','morele.net'] %}selected{% endif %}>morele</option>
          </select>
        </div>
        <div>
          <label for="query">Query</label>
          <input id="query" name="query" type="text" value="{{ search_query or '' }}" placeholder="e.g. RTX 4070" required>
        </div>
        <div style="display:flex; gap:10px;">
          <button class="btn" type="submit">Search</button>
        </div>
      </form>

      {% if search_results is not none %}
        <div style="margin-top:14px;">
          {% if not search_results %}
            <div class="muted">No results.</div>
          {% else %}
            <form method="post" action="/add-search" style="display:grid; gap:10px;">
              <input type="hidden" name="count" value="{{ search_results|length }}" />
              <table>
                <thead>
                  <tr>
                    <th style="width:28px;"></th>
                    <th>Name (editable)</th>
                    <th style="width:90px;">Price</th>
                  </tr>
                </thead>
                <tbody>
                  {% for h in search_results %}
                    {% set i = loop.index0 %}
                    <tr>
                      <td>
                        <input type="checkbox" name="select_{{ i }}" value="1" aria-label="Select" />
                      </td>
                      <td>
                        <input type="hidden" name="url_{{ i }}" value="{{ h.url }}" />
                        <input type="hidden" name="source_{{ i }}" value="{{ h.source }}" />
                        <input type="hidden" name="price_cents_{{ i }}" value="{{ '' if h.price_cents is none else h.price_cents }}" />
                        <input type="hidden" name="currency_{{ i }}" value="{{ '' if not h.currency else h.currency }}" />

                        <input name="name_{{ i }}" type="text" value="{{ h.name }}" />
                        <div class="muted" style="margin-top:6px;">
                          {{ h.source }} &middot; <a href="{{ h.url }}" target="_blank">open</a>
                        </div>
                      </td>
                      <td class="muted">
                        {% if h.price_cents is not none %}
                          {{ '%.2f' % (h.price_cents / 100.0) }} {{ h.currency or '' }}
                        {% else %}
                          n/a
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
              <div style="display:flex; gap:10px;">
                <button class="btn primary" type="submit">Add selected</button>
              </div>
            </form>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  const tbody = document.getElementById('products-body');
  if (!tbody) return;

  const form = document.getElementById('reorder-form');
  const input = document.getElementById('reorder-input');
  if (!form || !input) return;

  let draggedRow = null;

  function commitOrder() {
    const ids = Array.from(tbody.querySelectorAll('tr[data-pid]')).map(tr => tr.getAttribute('data-pid'));
    input.value = ids.join(',');
    form.submit();
  }

  tbody.addEventListener('dragstart', (e) => {
    const handle = e.target && e.target.closest ? e.target.closest('.drag-handle') : null;
    if (!handle) {
      e.preventDefault();
      return;
    }
    draggedRow = handle.closest('tr');
    if (!draggedRow) {
      e.preventDefault();
      return;
    }
    draggedRow.classList.add('dragging');
    if (e.dataTransfer) {
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', draggedRow.getAttribute('data-pid') || '');
    }
  });

  tbody.addEventListener('dragend', () => {
    if (draggedRow) draggedRow.classList.remove('dragging');
    draggedRow = null;
  });

  tbody.addEventListener('dragover', (e) => {
    if (!draggedRow) return;
    e.preventDefault();
    const overRow = e.target && e.target.closest ? e.target.closest('tr[data-pid]') : null;
    if (!overRow || overRow === draggedRow) return;

    const rect = overRow.getBoundingClientRect();
    const after = (e.clientY - rect.top) > (rect.height / 2);
    tbody.insertBefore(draggedRow, after ? overRow.nextSibling : overRow);
  });

  tbody.addEventListener('drop', (e) => {
    if (!draggedRow) return;
    e.preventDefault();
    commitOrder();
  });

  tbody.addEventListener('click', (e) => {
    const btn = e.target && e.target.closest ? e.target.closest('.edit-btn') : null;
    if (!btn) return;
    const row = btn.closest('tr[data-pid]');
    if (!row) return;
    const box = row.querySelector('.rename-box');
    if (!box) return;
    const willShow = box.hasAttribute('hidden');
    if (willShow) box.removeAttribute('hidden');
    else box.setAttribute('hidden', '');
    if (willShow) {
      const inp = box.querySelector('input[name="name"]');
      if (inp) inp.focus();
    }
  });
})();
</script>
{% endblock %}
