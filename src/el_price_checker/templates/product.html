{% extends "base.html" %}

{% block head_extra %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
{% endblock %}

{% block content %}
<div class="grid" style="grid-template-columns: 3fr 1fr; align-items: start;">
  <div class="card">
    <h2 style="margin-top:0;">{{ product.name }}</h2>
    <div class="muted" style="margin-bottom:8px;">{{ product.source }} &middot; <a href="{{ product.url }}" target="_blank">open product page</a></div>
    <div style="display:flex; gap:16px; align-items: center; flex-wrap: wrap;">
      <div><span class="muted">Last price</span><div style="font-size:26px;">{% if product.last_price %}{{ '%.2f' % product.last_price }} {{ product.currency }}{% else %}n/a{% endif %}</div></div>
      <div>
        <span class="muted">24h change</span>
        <div>
          {% if product.change_24h is not none %}
            {% if product.change_24h > 0 %}+{% endif %}{{ '%.2f' % product.change_24h }} {{ product.currency }}
          {% else %}
            <span class="muted">n/a</span>
          {% endif %}
        </div>
      </div>
      <div><span class="muted">Last seen</span><div>{{ product.last_seen or 'n/a' }}</div></div>
      {% if product.error %}<div class="tag" style="border-color:#f5f5f5;color:#f5f5f5;">{{ product.error }}</div>{% endif %}
    </div>
    <div style="margin-top:20px;">
      <canvas id="chart" height="140"></canvas>
    </div>
  </div>
  <div class="card">
    <h3 style="margin-top:0;">Actions</h3>
    <form method="post" action="/delete/{{ product.id }}" onsubmit="return confirm('Delete this product and history?');">
      <button class="btn danger" type="submit">Delete</button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(async function() {
  const resp = await fetch('/api/products/{{ product.id }}/history');
  const items = await resp.json();
  const points = items.filter(it => it.price !== null).map(it => ({ x: it.ts_ms, y: it.price }));
  const ctx = document.getElementById('chart');
  if (!ctx) return;
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [
        {
          label: 'Price',
          data: points,
          borderColor: '#ffffff',
          backgroundColor: 'rgba(255,255,255,0.12)',
          tension: 0.25,
          spanGaps: true,
        },
      ],
    },
    options: {
      responsive: true,
      scales: {
        x: {
          type: 'time',
          time: { unit: 'day' },
          ticks: { color: '#94a3b8' },
          grid: { color: '#1f2937' }
        },
        y: {
          ticks: { color: '#94a3b8' },
          grid: { color: '#1f2937' }
        }
      },
      plugins: {
        legend: { labels: { color: '#e2e8f0' } },
        tooltip: {
          callbacks: {
            label: ctx => ` ${ctx.parsed.y.toFixed(2)} ${items[0]?.currency || ''}`
          }
        }
      }
    }
  });
})();
</script>
{% endblock %}
